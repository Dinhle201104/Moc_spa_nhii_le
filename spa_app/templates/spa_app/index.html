{% load static l10n %}
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M·ªôc Spa - ƒê√°nh th·ª©c v·∫ª ƒë·∫πp t·ª± nhi√™n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{% static 'spa_app/css/styles.css' %}">
</head>

<body class="has-local-bg">
    <header class="navbar">
        <div class="logo-container">
            <div class="logo-circle">
                <span>M·ªôc Spa</span>
            </div>
        </div>
        <nav>
            <ul>
                <li><a href="#">Trang ch·ªß</a></li>
                <li><a href="#services">D·ªãch v·ª•</a></li>
                <li><a href="#bookingSummary">ƒê·∫∑t l·ªãch</a></li>
                <li><a href="{% url 'manage_services' %}">Qu·∫£n l√Ω</a></li>
                <li><a href="#contact">Li√™n h·ªá</a></li>
            </ul>
        </nav>
    </header>

    <section class="hero">
        <div class="hero-content">
            <h1>ƒê√°nh th·ª©c v·∫ª ƒë·∫πp t·ª± nhi√™n c·ªßa b·∫°n</h1>
            <p>Ch√†o m·ª´ng b·∫°n ƒë√£ ƒë·∫øn v·ªõi M·ªôc Spa</p>
            <a href="#services" class="btn-primary">ƒê·∫∑t l·ªãch ngay</a>
        </div>
    </section>

    <main id="services">
        <h2 class="section-title">D·ªãch v·ª• c·ªßa ch√∫ng t√¥i</h2>
        <div class="container">
            <div class="content-wrapper">
                <div class="services-grid">
                    {% for category in categories %}
                    <div class="category-section">
                        <h3>{{ category.name }}</h3>
                        <div class="cards-container">
                            {% for service in category.services.all %}
                            <div class="service-card" data-id="{{ service.id }}" data-name="{{ service.name|escapejs }}"
                                data-price="{{ service.price|unlocalize }}" data-duration="{{ service.duration }}">
                                <div class="card-image">
                                    {% if service.image %}
                                    <img src="{{ service.image.url }}" alt="{{ service.name }}">
                                    {% else %}
                                    <img src="https://images.unsplash.com/photo-1540555700478-4be289fbecef?auto=format&fit=crop&q=80&w=400"
                                        alt="Spa">
                                    {% endif %}
                                </div>
                                <div class="card-info">
                                    <h4>{{ service.name }}</h4>
                                    <p>{{ service.description }}</p>
                                    <div class="card-footer">
                                        <span class="price">{{ service.price|floatformat:0 }} VNƒê</span>
                                        <button class="btn-select">Ch·ªçn g√≥i</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <aside class="booking-summary" id="bookingSummary">
                    <div class="summary-card">
                        <h3>üßæ Th√¥ng Tin Li·ªáu Tr√¨nh</h3>
                        <div id="summaryContent" class="hidden">
                            <div class="booking-inputs">
                                <div class="sum-form-group">
                                    <label>H·ªç v√† t√™n ng∆∞·ªùi ƒë·∫∑t</label>
                                    <select id="bookerName">
                                        <option value="">-- ch·ªçn ng∆∞·ªùi ƒë·∫∑t ƒë∆°n --</option>
                                        <option value="ch·ªã Nhi">ch·ªã Nhi</option>
                                        <option value="N∆°">N∆°</option>
                                        <option value="Wu√¢y">Wu√¢y</option>
                                    </select>
                                </div>
                                <div class="sum-form-group">
                                    <label>Gi·∫£m gi√° (%)</label>
                                    <input type="number" id="discountPercent" value="0" min="0" max="100"
                                        oninput="updateSummary()">
                                </div>
                                <div class="sum-form-group">
                                    <label>H·ªç v√† t√™n kh√°ch h√†ng</label>
                                    <input type="text" id="customerName" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
                                </div>
                                <div class="sum-form-group">
                                    <label>S·∫£n ph·∫©m/M·ªπ ph·∫©m (n·∫øu c√≥)</label>
                                    <input type="text" id="productName" placeholder="T√™n s·∫£n ph·∫©m"
                                        oninput="updateSummary()">
                                </div>
                                <div class="sum-form-group">
                                    <label>Gi√° s·∫£n ph·∫©m (VNƒê)</label>
                                    <input type="number" id="productPrice" value="0" min="0" oninput="updateSummary()">
                                </div>
                                <div class="sum-form-group">
                                    <label>Gi·∫£m gi√° SP (%)</label>
                                    <input type="number" id="productDiscountPercent" value="0" min="0" max="100"
                                        oninput="updateSummary()">
                                </div>
                            </div>
                            <hr>
                            <div id="selectedServicesList">
                                <!-- Dynamic List -->
                            </div>
                            <hr>
                            <p><strong>T·ªïng th·ªùi gian:</strong> <span id="sumDuration">0</span> ph√∫t</p>
                            <p class="total"><strong>T·ªïng c·ªông:</strong> <span id="sumTotal">0 VNƒê</span></p>
                            <button class="btn-confirm" onclick="confirmBooking()">X√°c nh·∫≠n ƒë·∫∑t l·ªãch</button>
                        </div>
                        <p id="summaryPlaceholder">Vui l√≤ng ch·ªçn c√°c g√≥i d·ªãch v·ª• ƒë·ªÉ xem chi ti·∫øt.</p>
                    </div>
                </aside>
            </div>
        </div>
        <section id="contact" class="contact-section">
            <h2 class="section-title">Li√™n h·ªá v·ªõi ch√∫ng t√¥i</h2>
            <div class="container">
                <div class="contact-wrapper">
                    <div class="contact-info">
                        <div class="info-card">
                            <h3>üìç ƒê·ªãa ch·ªâ</h3>
                            <p>{{ contact.address|default:"25 L√™ L·ª£i, Th·ªã tr·∫•n Khe Sanh, H∆∞·ªõng H√≥a, T·ªânh Qu·∫£ng Tr·ªã" }}
                            </p>
                        </div>
                        <div class="info-card">
                            <h3>üìû ƒêi·ªán tho·∫°i</h3>
                            <p>{{ contact.phone|default:"0962 176 994" }}</p>
                        </div>
                        <div class="info-card">
                            <h3>‚úâÔ∏è Email</h3>
                            <p>{{ contact.email|default:"lenhi2408@gmail.com" }}</p>
                        </div>
                        <div class="info-card">
                            <h3>üåê Facebook</h3>
                            <p>
                                {% if contact.facebook_url %}
                                <a href="{{ contact.facebook_url }}" target="_blank"
                                    style="text-decoration: none; color: inherit;">
                                    {{ contact.facebook_name|default:"Nhii L√™" }}
                                </a>
                                {% else %}
                                <a href="https://www.facebook.com/share/1CMBCBMoAv/?mibextid=wwXIfr" target="_blank"
                                    style="text-decoration: none; color: inherit;">
                                    Nhii L√™
                                </a>
                                {% endif %}
                            </p>
                        </div>
                        <div class="info-card">
                            <h3>‚è∞ Gi·ªù m·ªü c·ª≠a</h3>
                            <p>{{ contact.working_hours|default:"Th·ª© 2 - Ch·ªß Nh·∫≠t: 08:00 - 20:00" }}</p>
                        </div>
                    </div>
                    <div class="contact-form-container">
                        <form class="contact-form">
                            <div class="form-group">
                                <input type="text" placeholder="H·ªç v√† t√™n" required>
                            </div>
                            <div class="form-group">
                                <input type="email" placeholder="Email" required>
                            </div>
                            <div class="form-group">
                                <textarea placeholder="Tin nh·∫Øn c·ªßa b·∫°n" rows="5" required></textarea>
                            </div>
                            <button type="button" class="btn-primary"
                                onclick="alert('C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá! Ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t.')">G·ª≠i l·ªùi
                                nh·∫Øn</button>
                        </form>
                    </div>
                </div>
                <div class="map-container">
                    <iframe
                        src="https://maps.google.com/maps?q=25%20L√™%20L·ª£i,%20Th·ªã%20tr·∫•n%20Khe%20Sanh,%20H∆∞·ªõng%20H√≥a,%20Qu·∫£ng%20Tr·ªã&t=&z=15&ie=UTF8&iwloc=&output=embed"
                        width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy">
                    </iframe>
                </div>
            </div>
        </section>

        <div id="invoiceOverlay" class="overlay hidden">
            <div class="invoice-card">
                <div class="invoice-header-area">
                    <h3 id="checkoutTitle">THANH TO√ÅN ƒê∆†N H√ÄNG</h3>
                </div>

                <div class="invoice-split-container">
                    <!-- Left Column: Invoice Preview -->
                    <div class="invoice-preview-col">
                        <div class="invoice-preview-content" id="invoicePreview">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- Right Column: Payment & Controls -->
                    <div class="payment-control-col">
                        <div class="payment-selection-content">
                            <div id="paymentSelection">
                                <h4 style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
                                    üí≥ PH∆Ø∆†NG TH·ª®C THANH TO√ÅN</h4>
                                <div class="payment-methods">
                                    <button onclick="selectPayment('cash')" class="btn-payment">
                                        <span class="icon">üíµ</span> Ti·ªÅn m·∫∑t
                                    </button>
                                    <button onclick="selectPayment('transfer')" class="btn-payment">
                                        <span class="icon">üì±</span> Chuy·ªÉn kho·∫£n
                                    </button>
                                </div>

                                <div id="cashInputArea" class="payment-detail hidden">
                                    <div class="sum-form-group">
                                        <label>S·ªë ti·ªÅn kh√°ch ƒë∆∞a (VNƒê)</label>
                                        <input type="number" id="cashReceived" placeholder="V√≠ d·ª•: 500000"
                                            oninput="calculateChange()">
                                    </div>
                                    <p><strong>Ti·ªÅn th·ªëi l·∫°i:</strong> <span id="cashChange">0 VNƒê</span></p>
                                    <button onclick="processPayment('cash')" class="btn-action primary full-width">X√°c
                                        nh·∫≠n thanh
                                        to√°n & In h√≥a ƒë∆°n</button>
                                </div>

                                <div id="transferArea" class="payment-detail hidden">
                                    <div class="qr-container">
                                        {% if contact.qr_code %}
                                        <img src="{{ contact.qr_code.url }}" alt="QR Code Payment" class="qr-image">
                                        {% else %}
                                        <div class="qr-placeholder">
                                            <p>Ch∆∞a c√≥ m√£ QR.</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <p class="text-center" style="font-size: 0.85rem; margin-bottom: 1rem;">Qu√©t m√£ QR
                                        ƒë·ªÉ chuy·ªÉn kho·∫£n</p>
                                    <button onclick="processPayment('transfer')"
                                        class="btn-action primary full-width">ƒê√£ nh·∫≠n ƒë∆∞·ª£c
                                        ti·ªÅn & In h√≥a ƒë∆°n</button>
                                </div>
                            </div>

                            <div id="finalInvoiceActions" class="hidden">
                                <h4
                                    style="margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
                                    ‚úÖ HO√ÄN T·∫§T ƒê∆†N H√ÄNG</h4>
                                <div class="invoice-actions no-print">
                                    <button onclick="window.print()" class="btn-action full-width">
                                        <i class="fas fa-print"></i> In h√≥a ƒë∆°n
                                    </button>
                                    <button onclick="location.reload()" class="btn-action primary full-width">
                                        <i class="fas fa-check-circle"></i> Ho√†n t·∫•t giao d·ªãch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="invoice-footer-area no-print">
                    <div class="invoice-actions" style="flex-direction: row; justify-content: flex-end; gap: 10px;">
                        <button onclick="cancelBooking()" class="btn-action danger"
                            style="padding: 0.7rem 1.5rem; border-radius: 8px;">H·ªßy ƒë·∫∑t l·ªãch</button>
                        <button onclick="closeInvoice()" class="btn-action"
                            style="padding: 0.7rem 1.5rem; border-radius: 8px;">Quay l·∫°i</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentInvoiceData = null;
            let selectedServices = [];

            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.service-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const id = card.getAttribute('data-id');
                        const name = card.getAttribute('data-name');
                        const price = parseFloat(card.getAttribute('data-price'));
                        const duration = parseInt(card.getAttribute('data-duration'));
                        toggleService(id, name, price, duration, card);
                    });
                });
            });

            function toggleService(id, name, price, duration, element) {
                const index = selectedServices.findIndex(s => s.id === id);
                if (index > -1) {
                    selectedServices.splice(index, 1);
                    element.classList.remove('selected');
                } else {
                    selectedServices.push({ id, name, price, duration });
                    element.classList.add('selected');
                }
                updateSummary();
            }

            function updateSummary() {
                const list = document.getElementById('selectedServicesList');
                const content = document.getElementById('summaryContent');
                const placeholder = document.getElementById('summaryPlaceholder');
                const productName = document.getElementById('productName').value.trim();

                if (selectedServices.length === 0 && productName === "") {
                    content.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                    return;
                }

                content.classList.remove('hidden');
                placeholder.classList.add('hidden');

                list.innerHTML = selectedServices.map(s => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        <span>${s.name}</span>
                        <span>${s.price.toLocaleString('vi-VN')} VNƒê</span>
                    </div>
                `).join('');

                const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
                const basePrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
                const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
                const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
                const productDiscountPercent = parseFloat(document.getElementById('productDiscountPercent').value) || 0;

                const serviceTotal = basePrice * (1 - discountPercent / 100);
                const productTotal = productPrice * (1 - productDiscountPercent / 100);
                const totalPrice = serviceTotal + productTotal;

                document.getElementById('sumDuration').innerText = totalDuration;
                document.getElementById('sumTotal').innerText = totalPrice.toLocaleString('vi-VN') + " VNƒê";
            }

            async function confirmBooking() {
                try {
                    const productName = document.getElementById('productName').value.trim();
                    if (selectedServices.length === 0 && productName === "") {
                        alert('Vui l√≤ng ch·ªçn d·ªãch v·ª• ho·∫∑c nh·∫≠p s·∫£n ph·∫©m.');
                        return;
                    }

                    const bookerName = document.getElementById('bookerName').value;
                    const customerName = document.getElementById('customerName').value;
                    const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;

                    if (!bookerName) {
                        alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi ƒë·∫∑t l·ªãch.');
                        return;
                    }

                    if (!customerName.trim()) {
                        alert('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n kh√°ch h√†ng.');
                        return;
                    }

                    const serviceIds = selectedServices.map(s => s.id);

                    const response = await fetch('/confirm_booking/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            service_ids: serviceIds,
                            booker_name: bookerName,
                            customer_name: customerName,
                            discount_percent: discountPercent,
                            product_name: document.getElementById('productName').value || '',
                            product_price: parseFloat(document.getElementById('productPrice').value) || 0,
                            product_discount_percent: parseFloat(document.getElementById('productDiscountPercent').value) || 0
                        })
                    });

                    if (!response.ok) {
                        throw new Error('L·ªói t·ª´ m√°y ch·ªß: ' + response.status);
                    }

                    const data = await response.json();
                    if (data.status === 'success') {
                        currentInvoiceData = data.invoice;

                        // Initial Invoice Preview Render (Left Side)
                        renderInvoicePreview();

                        // Reset Right Side (Payment Controls)
                        document.getElementById('checkoutTitle').innerText = "THANH TO√ÅN ƒê∆†N H√ÄNG";
                        document.getElementById('paymentSelection').classList.remove('hidden');
                        document.getElementById('finalInvoiceActions').classList.add('hidden');
                        document.getElementById('cashInputArea').classList.add('hidden');
                        document.getElementById('transferArea').classList.add('hidden');

                        document.getElementById('invoiceOverlay').classList.remove('hidden');
                    } else {
                        alert('ƒê√£ x·∫£y ra l·ªói: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error confirming booking:', error);
                    alert('ƒê√£ x·∫£y ra l·ªói khi ƒë·∫∑t l·ªãch: ' + error.message);
                }
            }

            function selectPayment(method) {
                document.getElementById('cashInputArea').classList.add('hidden');
                document.getElementById('transferArea').classList.add('hidden');

                if (method === 'cash') {
                    document.getElementById('cashInputArea').classList.remove('hidden');
                } else if (method === 'transfer') {
                    document.getElementById('transferArea').classList.remove('hidden');
                }
            }

            function calculateChange() {
                if (!currentInvoiceData) return;
                const totalText = currentInvoiceData.total.replace(/[., VNƒê]/g, '');
                const total = parseInt(totalText);
                const received = parseInt(document.getElementById('cashReceived').value) || 0;
                const change = received - total;
                document.getElementById('cashChange').innerText = (change > 0 ? change.toLocaleString('vi-VN') : 0) + " VNƒê";
            }

            function renderInvoicePreview(paymentInfoHtml = '') {
                if (!currentInvoiceData) return;

                let invoiceRows = currentInvoiceData.services.map(s => `
                    <tr><td>${s.name}</td><td>${s.price}</td></tr>
                `).join('');

                const previewContent = `
                    <div class="invoice-header">
                        <p><strong>M√£ h√≥a ƒë∆°n:</strong> ${currentInvoiceData.id}</p>
                        <p><strong>Ng∆∞·ªùi ƒë·∫∑t:</strong> ${currentInvoiceData.booker_name}</p>
                        <p><strong>Kh√°ch h√†ng:</strong> ${currentInvoiceData.customer_name}</p>
                        <p><strong>Ng√†y:</strong> ${currentInvoiceData.date}</p>
                    </div>
                    <div class="invoice-details">
                        <p><strong>Danh s√°ch d·ªãch v·ª•:</strong> ${currentInvoiceData.service_names}</p>
                        <p><strong>T·ªïng th·ªùi gian:</strong> ${currentInvoiceData.duration}</p>
                    </div>
                    <table class="invoice-table">
                        <thead>
                            <tr><th>N·ªôi dung</th><th>S·ªë ti·ªÅn</th></tr>
                        </thead>
                        <tbody>
                            ${invoiceRows}
                            <tr><td>Gi·∫£m gi√° DV</td><td>-${currentInvoiceData.discount_amount} (${currentInvoiceData.discount_percent}%)</td></tr>
                            ${currentInvoiceData.product_name ? `<tr><td>S·∫£n ph·∫©m: ${currentInvoiceData.product_name}</td><td>${currentInvoiceData.product_price}</td></tr>` : ''}
                            ${currentInvoiceData.product_discount_percent > 0 ? `<tr><td>Gi·∫£m gi√° SP</td><td>-${currentInvoiceData.product_discount_amount} (${currentInvoiceData.product_discount_percent}%)</td></tr>` : ''}
                            <tr class="row-total"><td>T·ªïng c·ªông</td><td>${currentInvoiceData.total}</td></tr>
                            ${paymentInfoHtml}
                        </tbody>
                    </table>
                `;
                document.getElementById('invoicePreview').innerHTML = previewContent;
            }

            async function processPayment(method) {
                if (!currentInvoiceData) return;

                // Update status on server
                try {
                    const response = await fetch('/finalize_payment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            booking_id: currentInvoiceData.booking_id,
                            method: method
                        })
                    });

                    if (!response.ok) console.error('Failed to finalize payment on server');
                } catch (error) {
                    console.error('Error finalizing payment:', error);
                }

                let paymentInfoHtml = '';
                if (method === 'cash') {
                    const received = parseInt(document.getElementById('cashReceived').value) || 0;
                    const totalText = currentInvoiceData.total.replace(/[., VNƒê]/g, '');
                    const total = parseInt(totalText);

                    if (received < total) {
                        alert('S·ªë ti·ªÅn kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß!');
                        return;
                    }

                    const change = received - total;
                    paymentInfoHtml = `
                        <tr><td>HT Thanh to√°n</td><td>Ti·ªÅn m·∫∑t</td></tr>
                        <tr><td>Ti·ªÅn kh√°ch ƒë∆∞a</td><td>${received.toLocaleString('vi-VN')} VNƒê</td></tr>
                        <tr><td>Ti·ªÅn th·ªëi l·∫°i</td><td>${change.toLocaleString('vi-VN')} VNƒê</td></tr>
                    `;
                } else {
                    paymentInfoHtml = `
                        <tr><td>HT Thanh to√°n</td><td>Chuy·ªÉn kho·∫£n</td></tr>
                        <tr><td>Tr·∫°ng th√°i</td><td>ƒê√£ nh·∫≠n ƒë∆∞·ª£c ti·ªÅn</td></tr>
                    `;
                }

                // Update the static preview on the left with payment details
                renderInvoicePreview(paymentInfoHtml);

                // Switch UI on the right
                document.getElementById('checkoutTitle').innerText = "HO√ÄN T·∫§T GIAO D·ªäCH";
                document.getElementById('paymentSelection').classList.add('hidden');
                document.getElementById('finalInvoiceActions').classList.remove('hidden');
            }

            function closeInvoice() {
                document.getElementById('invoiceOverlay').classList.add('hidden');
            }

            function cancelBooking() {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy l∆∞·ª£t ƒë·∫∑t l·ªãch n√†y kh√¥ng?')) {
                    selectedServices = [];
                    updateSummary();
                    document.querySelectorAll('.service-card.selected').forEach(card => card.classList.remove('selected'));
                    closeInvoice();
                }
            }
        </script>
</body>

</html>